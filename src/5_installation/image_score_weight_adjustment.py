import sys
from collections import defaultdict, OrderedDict
import math
import json
import os
from tqdm import tqdm
import numpy as np
import re
from collections import Counter, OrderedDict

# mostly completely black images that we don't want to match / print
IMG_BLACKLIST = [800175, 435716, 81573, 762831, 177194, 499334, 730007, 700771, 335367, 383716, 198935, 547409, 78209, 1102175, 1102055, 569218, 1102060, 210786, 668866, 91049, 711509, 91799, 520968, 550537, 1235756, 378077, 208735, 290389, 498755, 428709, 657348, 157413, 1203175, 779539, 1212921, 437749, 385213, 612309, 1133285, 136809, 714106, 74526, 226663, 729699, 194982, 370264, 600860, 512278, 269703, 31795, 1210490, 601226, 1211217, 429304, 387397, 448348, 677161, 288055, 737962, 441157, 755243, 122196, 801931, 1235744, 700757, 609525, 31265, 132219, 31654, 1203174, 732589, 355192, 453701, 796251, 108392, 228858, 178875, 225696, 607865, 29717, 250795, 299448, 738740, 346461, 121358, 230098, 581426, 652895, 475798, 9466, 43704, 784880, 1210482, 586675, 1211184, 300083, 728213, 264624, 597450, 464023, 454599, 206397, 55127, 1218637, 1226088, 636828, 423756, 716345, 438100, 463856, 741197, 426106, 797227, 250551, 37303, 190370, 363790, 134655, 598134, 628163, 716698, 88700, 252500, 538128, 151768, 626342, 329492, 90218, 66980, 479742, 213735, 306819, 314704, 518715, 63839, 201514, 75976, 247837, 1218856, 361506, 786305, 161553, 557752, 600266, 205973, 33941, 1221578, 118449, 243484, 462177, 280443, 604971, 73026, 829535, 605624, 1220832, 198935, 547409, 1102060, 1102055, 1102175, 177194, 78209, 383716, 435716, 730007, 1102055, 1102175, 1102060, 499334, 198935, 547409, 668866, 520968, 800175, 91799, 335367, 1235756, 569218, 498755, 378077, 208735, 210786, 74526, 700771, 428709, 157413, 762831, 612309, 385213, 290389, 1133285, 194982, 609525, 512278, 600860, 91049, 801931, 31795, 550537, 711509, 250795, 714106, 108392, 370264, 136809, 1203175, 355192, 9466, 1210490, 737962, 1212921, 738740, 387397, 610132, 755243, 729699, 1210482, 601226, 230098, 475798, 448348, 784880, 437749, 426106, 1221578, 1226088, 226663, 1211184, 311732, 429304, 269703, 103151, 716698, 438100, 441157, 1211217, 732589, 700757, 754376, 122196, 779539, 280443, 258933, 29717, 1218637, 31265, 657348, 206397, 1220832, 121358, 677161, 363790, 453701, 66980, 517294, 600266, 213735, 482934, 607865, 171551, 252500, 535837, 518715, 161602, 1203174, 734213, 675543, 132219, 317556, 181703, 3161, 129502, 300083, 261710, 688112, 692341, 47787, 105503, 454599, 292006, 201225, 459504, 796251, 377387, 785698, 77961, 528394, 581426, 247837, 683869, 138632, 538128, 728213, 1235744, 557752, 467066, 652895, 636828, 741197, 786305, 90218, 429913, 43704, 58266, 75976, 462177, 227846, 368674, 734598, 593784, 545750, 458098, 730608, 72237, 236934, 845636, 605624, 487608, 237490, 110405, 250551, 193265, 829535, 493895, 845641, 243484, 350305, 713766, 628163, 192673, 848596, 783269, 791123, 184315, 453729, 156516, 81942, 579323, 314704, 674352, 598134, 19114, 829534, 609517, 310270, 692159, 264624, 829536, 721648, 88700, 73026, 423756, 549505, 351473, 18455, 225696, 694224, 33941, 559950, 793237, 276206, 586675, 718784, 227916, 168542, 215020, 548193, 859409, 601316, 573496, 264920, 164356, 676715, 86490, 355568, 280859, 421764, 634644, 541435, 31654, 264287, 359281, 361506, 609499, 39446, 92922, 315915, 270510, 797227, 21018, 557203, 63839, 343139, 463856, 190370, 466113, 729299, 290674, 1218856, 211070, 737359, 88783, 570113, 306819, 540986, 1244655, 433040, 666597, 464023, 429180, 812350, 545024, 401210, 732156, 177926, 329492, 604971, 205973, 286065, 285463, 118449, 460022, 574038, 7665, 76158, 72847, 334379, 853013, 770088, 266049, 30200, 408410, 737671, 123417, 111245, 560919, 55127, 638704, 638372, 626342, 166641, 716882, 170108, 1216359, 1245499, 137335, 378527, 266607, 552684, 654316, 479742, 460505, 273672, 346461, 742337, 166333, 348791, 151768, 220866, 68767, 388346, 247038, 6733, 573511, 1207854, 770148, 716345, 397565, 673914, 514692, 362651, 488433, 363090, 314689, 1087394, 586619, 688395, 248364, 1234102, 390472, 7653, 347097, 132817, 387854, 34553, 669904, 93874, 780629, 128454, 251416, 101318, 191393, 152240, 69673, 445933, 154021, 185801, 726338, 371552, 597450, 103658, 659372, 299448, 389621, 349212, 322040, 358221, 781756, 565890, 277895, 1226339, 395144, 80220, 199748, 102468, 123307, 564869, 621499, 735570, 78752, 163268, 255910, 649075, 513800, 750118, 488006, 601836, 150106, 188211, 524072, 594230, 1030731, 21515, 420761, 666082, 282836, 736960, 215578, 161553, 162562, 361163, 473095, 348277, 64126, 155050, 327091, 248890, 523667, 531002, 316027, 704952, 358293, 408046, 338100, 531047, 459148, 822676, 653340, 495213, 194311, 604145, 1145926, 424194, 354132, 419003, 448372, 311266, 1234262, 394887, 281669, 758700, 647290, 35047, 230916, 501697, 343094, 768719, 306320, 588010, 512431, 607687, 126513, 693635, 818444, 150700, 773567, 816668, 555010, 533970, 135536, 416849, 170188, 187566, 752947, 304893, 658967, 736072, 1041810, 720064, 452799, 508413, 739341, 681987, 782977, 707291, 721753, 772392, 609529, 790424, 445535, 416314, 815212, 794900, 744039, 651360, 191416, 244150, 70934, 37303, 769995, 1217624, 562370, 683933, 681160, 464582, 604127, 769273, 117269, 257303, 508946, 572058, 55338, 507938, 569341, 178875, 800315, 443309, 94541, 607908, 658728, 76795, 194657, 577259, 282585, 806105, 360216, 1213525, 552506, 646310, 1235759, 645905, 592818, 307261, 763410, 449161, 299682, 203158, 35841, 694862, 810689, 52287, 758334, 40345, 472453, 403820, 423470, 100048, 486364, 215130, 382518, 719771, 291977, 581987, 516544, 295061, 1236595, 769389, 849405, 371368, 37765, 489789, 222427, 711302, 594682, 772727, 1208038, 415193, 1223352, 159656, 625528, 725556, 149559, 274910, 220671, 748605, 1200421, 320132, 234574, 810782, 185805, 528783, 592409, 320093, 306523, 229110, 279762, 49782, 517406, 161560, 326861, 853015, 201514, 574250, 651770, 27288, 540193, 961354, 648069, 628219, 624170, 692104, 822464, 559790, 102656, 13602, 147677, 146339, 742616, 472335, 20109, 116541, 1149000, 153265, 386064, 654394, 734846, 320718, 82032, 10281, 338195, 444769, 475169, 312961, 210416, 481650, 172930, 652524, 244733, 676260, 227345, 10709, 86142, 738602, 640135, 207586, 659945, 764709, 160980, 562685, 813237, 551069, 514474, 431510, 812085, 469854, 865605, 117841, 158960, 1235743, 105416, 1211219, 101026, 443986, 542797, 20909, 425555, 159339, 417494, 772815, 140196, 502847, 46863, 648457, 790487, 47937, 123477, 211202, 187568, 569911, 285400, 8810, 434970, 853009, 811195, 751320, 505401, 23850, 785636, 105311, 201036, 62220, 398569, 290045, 786947, 537180, 792649, 74263, 632443, 78514, 1065711, 784147, 182862, 14068, 473721, 82203, 469415, 773796, 134972, 520155, 331937, 761423, 447059, 454539, 156347, 792153, 90511, 643264, 707395, 541347, 649254, 767621, 648170, 60867, 781079, 139508, 491854, 94939, 626823, 326443, 562949, 138520, 480532, 476076, 516143, 1060929, 72326, 219450, 36275, 430890, 371527, 137, 550131, 320599, 497739, 498104, 288419, 406890, 795678, 412313, 550846, 59202, 305354, 773934, 667387, 588828, 178610, 260420, 131145, 576581, 548591, 623361, 486895, 425660, 155236, 66235, 729944, 236103, 1176817, 218580, 610791, 756118, 799579, 396441, 852304, 128909, 3438, 495073, 755310, 559349, 462856, 766900, 735162, 1212240, 679423, 253105, 800039, 157506, 440232, 32356, 820005, 13414, 417902, 612065, 790262, 772223, 407911, 479707, 671333, 772032, 477097, 691490, 56809, 151813, 441609, 534415, 171748, 1235746, 24813, 349130, 377666, 785233, 279686, 711119, 97621, 735280, 491156, 452840, 488805, 540682, 107091, 961251, 190452, 619802, 678326, 639635, 1211180, 479600, 1224879, 130932, 638698, 136737, 277539, 690442, 557038, 303742, 140487, 8852, 206630, 370463, 701931, 603733, 715762, 1065635, 165613, 84847, 469831, 450988, 637182, 142152, 178849, 790728, 275688, 806806, 455679, 283075, 479711, 605292, 94817, 410892, 707054, 741862, 279940, 575570, 79888, 191574, 461076, 133972, 288055, 723746, 202843, 166864, 58154, 3153, 228005, 124042, 368449, 342262, 629672, 275006, 597558, 460278, 417585, 844, 477676, 667986, 717282, 389382, 370669, 849389, 809470, 258949, 429851, 1219754, 588064, 786837, 649406, 626507, 297164, 99663, 373379, 439195, 691560, 174415, 588749, 268252, 652863, 421039, 328307, 852918, 495242, 868568, 103506, 458401, 34890, 568644, 729491, 655670, 424591, 497960, 81573, 799166, 386767, 399269, 373355, 32908, 246852, 53057, 205276, 449295, 344135, 308854, 72826, 675759, 782831, 670061, 195507, 457945, 186134, 11621, 506621, 320894, 238055, 852919, 534620, 576348, 420376, 577353, 321329, 859411, 104930, 804651, 83093, 376835, 188749, 716858, 807814, 681723, 132049, 743081, 384806, 750697, 488364, 859101, 163782, 138730, 207897, 334444, 712550, 16262, 1235762, 159323, 595148, 257164, 449465, 389061, 219248, 449286, 731124, 498168, 234771, 358863, 375454, 813183, 535409, 241077, 465194, 21261, 523465, 454629, 277500, 364692, 617763, 808016, 290777, 101161, 788017, 45657, 467801, 512486, 142609, 475650, 312747, 591622, 161407, 13357, 458570, 438548, 780601, 116484, 271139, 211270, 636000, 1046393, 536428, 120892, 263521, 191568, 647445, 491329, 565361, 464074, 962863, 457569, 874789, 263220, 136554, 398989, 593991, 407449, 323440, 237301, 735746, 1235760, 641070, 447450, 498647, 423095, 803200, 773986, 445125, 539025, 94910, 494062, 682866, 554354, 222630, 325006, 666795, 815490, 771466, 27713, 36136, 30842, 770818, 477935, 42770, 721117, 671530, 504764, 225706, 230317, 576959, 62317, 29344, 541103, 141250, 1060300, 109095, 669435, 321454, 146847, 579493, 355519, 106338, 701037, 365649, 874895, 852306, 403576, 360863, 65382, 356268, 500142, 853016, 302072, 1235761, 776613, 13437, 243509, 50665, 225266, 39036, 961456, 384485, 17509, 756802, 276556, 480153, 186480, 616821, 759147, 549482, 785310, 336033, 241032, 143707, 272139, 528439, 163456, 730721, 514588, 233585, 859410, 638616, 198456, 128737, 228989, 960690, 247996, 78744, 709927, 698197, 55592, 222175, 470728, 210213, 327685, 725813, 178283, 176775, 470507, 490314, 75904, 463648, 228632, 569720, 71024, 740606, 775484, 771182, 309805, 64682, 5850, 194145, 425229, 735052, 406932, 486824, 257640, 755528, 36256, 417745, 799016, 1211857, 601139, 607309, 640538, 491807, 751625, 450893, 514949, 815407, 73237, 167836, 356337, 301621, 85707, 439338, 97929, 670503, 853817, 169915, 775424, 185295, 227618, 110227, 678409, 614299, 501569, 479844, 1045883, 399530, 184396, 381126, 790144, 382001, 36103, 374537, 868506, 87147, 208477, 692302, 47597, 726867, 415372, 962780, 723989, 11676, 236267, 338065, 772309, 398131, 371342, 252053, 227092, 622868, 429825, 452428, 43483, 665125, 467741, 72119, 206478, 25709, 55180, 731727, 28880, 740842, 105729, 1239706, 791040, 754255, 748221, 442911, 569732, 509993, 741288, 457454, 800237, 464330, 144498, 161007, 1096814, 438358, 771593, 414707, 726569, 152930, 767671, 238353, 230121, 211249, 581399, 190162, 356137, 797331, 464669, 26413, 367622, 287705, 620306, 318042, 62984, 617032, 532641, 769182, 312399, 788110, 56651, 568337, 25708, 798998, 426821, 460424, 733074, 403900, 251316, 711074, 452717, 753904, 678373, 799094, 714921, 192031, 636745, 389147, 670752, 322312, 486437, 182759, 808285, 396233, 279476, 145658, 98021, 276571, 61606, 715738, 47355, 532526, 467888, 962689, 44681, 77497, 83663, 963110, 103476, 773371, 603262, 507391, 110581, 409889, 146034, 514052, 240505, 71930, 627610, 242212, 624950, 785172, 319619, 564908, 700404, 289727, 745593, 145381, 614428, 444985, 448200, 32709, 715200, 700660, 252541, 261414, 416839, 711822, 92420, 395712, 414987, 59308, 195001, 809555, 853008, 351236, 1046732, 669696, 742584, 50339, 817354, 808881, 634116, 329372, 73005, 329876, 440589, 438082, 423554, 198935, 547409, 1102060, 1102175, 1102055]

NORMALIZATION = {
  # max euclidean distance to 2048 dimensions
  'tf': math.sqrt(2048),
  # unsure of current normalization, but values are small enough
  'hist': 1,
  'ahash': 64,
  'dhash': 64,
  'phash': 64,
  'whash': 64,
  'hist_ahash': 1,
  'hist_dhash': 1,
  'hist_phash': 1,
  'hist_whash': 1,

  'image_ratio': 1,
  'multi_hist': 1,
  'lines_angle_hist': 64,
  'lines_vert_dist_hist': 64,
  'lines_horiz_dist_hist': 64,
}
ALGOS = NORMALIZATION.keys()

# values set on apr 16 2018
global_transfer_value = 2.8346456692913384
global_input_max = 77.953
global_output_max = 1.299

all_weights = defaultdict(int)
all_weights.update({"ahash":0.787,"dhash":1.102,"hist":17.008,"hist_ahash":0.630,
  "hist_dhash":0.630,"hist_phash":12.441,"hist_whash":0.945,"image_ratio":1.102,
  "lines_angle_hist":5.512,"lines_horiz_dist_hist":3.622,"lines_vert_dist_hist":3.622,
  "multi_hist":6.772,"phash":3.150,"tf":20.000,"whash":0.787})

def normalize_img_diff_data(img_diff_data):
  # applying blacklist
  # https://stackoverflow.com/a/28256912/426790
  img_diff_data = img_diff_data[~img_diff_data.index.isin(IMG_BLACKLIST)]

  print 'Normalizing Data'
  algo_norm_dict = {algo: NORMALIZATION[algo] for algo in img_diff_data}
  return 1 - img_diff_data.divide(algo_norm_dict)

def get_top_img_match_by_weights(img_diff_data):
  global global_transfer_value
  global global_input_max
  global global_output_max

  normalized_img_diff_data = normalize_img_diff_data(img_diff_data)
  
  weighted_ids = []
  for algo in ALGOS:
    # algo can be not in the pickled diff data
    # as lines only outputs columns for horiz or vert if
    # there were vert or horiz lines found...
    if algo not in normalized_img_diff_data:
      continue

    # (knob * algo_diff) ** transfer
    img_algo_result = (normalized_img_diff_data[algo].fillna(0) ** global_transfer_value) * all_weights[algo]
    # linearly transpose all results
    img_algo_result = (img_algo_result / global_input_max) * global_output_max

    # add weighted col to output
    weighted_ids.append(img_algo_result)

  # squish weighted values
  weighted_ids = sum(weighted_ids)
  weighted_ids = weighted_ids.sort_values(ascending=False)

  # return the TOP matching image converted to percentage!
  top_matching_image_score = (weighted_ids[:1] * 100.0)
  top_match_index, top_match_score = top_matching_image_score.to_dict().items()[0]
  return {
    'index': top_match_index,
    'score': top_match_score,
  }
